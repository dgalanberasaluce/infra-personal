# Incident Post-Mortem: Proxmox Node I/O Hang & CPU Spike

**Incident ID:** 20260131-PXM-01

**Date:** January 31, 2026

**Status:** Resolved (Mitigation Applied)

**Severity:** P1 (Critical - Total Node Unavailability)

---

## 1. Executive Summary

Between approximately 04:30 and 8:30 UTC, the Proxmox node experienced a total system hang preceded by a 100% CPU utilization spike. The root cause was identified as a **Controller Reset** on the primary NVMe storage (**Samsung 990 PRO 4TB**), which triggered a ZFS pool suspension. The system became unresponsive to management commands, necessitating a hard power cycle (Hard Reset) to restore service.

---

## 2. Impact

* **Infrastructure:** Complete loss of all Virtual Machines (VMs) and LXC Containers hosted on the `nvme-pool`.
* **Performance:** Host CPU saturation caused by kernel-level I/O wait threads (`z_wr_iss`, `z_wr_int`).
* **Availability:** Total downtime of approximately 4 hours.

---

## 3. Timeline (UTC)

* **05:30:** Initial telemetry alerts show CPU usage climbing to 100%. No corresponding increase in VM-guest application load.
* **06:15:** ZFS Pool enters `SUSPENDED` state. Proxmox GUI becomes unresponsive.
* **08:30:** Terminal session attempt. `zpool clear` command is issued but enters an uninterruptible sleep state (D-state), causing a terminal hang.
* **09:10:** SMART analysis of the drive reveals the fatal event: `Aborted: Controller Reset`.
* **09:25:** Emergency Hard Reset performed.
* **09:35:** Node returns to online status. Verification of ZFS pool integrity begins.

---

## 4. Root Cause Analysis (RCA)

The failure was triggered by a **Hardware-Software Communication Deadlock** involving the NVMe **Autonomous Power State Transition (APST)**.

1. **The Trigger:** Despite running the latest firmware (**4B2QJXD7**), the Samsung 990 PRO controller attempted to enter a low-power state during a micro-lull in I/O operations.
2. **The Failure:** The transition back to "Power State 0" (High Performance) failed or exceeded the kernel's timeout threshold. The NVMe controller issued an internal reset to recover.
3. **The Propagation:** During the reset, the PCIe link became unstable. ZFS, designed for data integrity, detected the missing device and suspended all I/O.
4. **The CPU Spike:** The Linux Kernel entered a loop, repeatedly trying to re-issue write commands to a device that was effectively "invisible" but not yet "detached," leading to the observed high CPU usage in worker threads.

---

## 5. Mitigation & Action Items

### Immediate Actions (Completed)

* **Hardware Recovery:** Forced power cycle to re-initialize the PCIe bus and NVMe controller.
* **Diagnostic Sweep:** Performed `smartctl` deep dive. Physical health confirmed at 100% (0% wearout).
* **Kernel Patching:** Applied `nvme_core.default_ps_max_latency_us=0` to the GRUB configuration to prevent the drive from ever entering low-power states.

### Corrective Tasks (To Be Completed)

* **[Action]** Set ZFS failmode to `panic` (`zpool set failmode=panic <pool>`). This ensures the node reboots automatically upon storage failure rather than hanging in a "zombie" state.
* **[Action]** Audit the motherboard BIOS/UEFI to disable **ASPM** (Active State Power Management) on the PCIe slots.
* **[Action]** Implement external monitoring (Proxmox Backup Server or Nagios/Zabbix) to alert on `dmesg` I/O errors specifically.

---

### Final Thoughts

The Samsung 990 PRO is an elite consumer drive, but its aggressive energy-saving features are fundamentally at odds with the "always-on" nature of ZFS. By disabling power state transitions, we have transformed this drive from a "Desktop" profile to a "Server" profile. Stability is expected to remain high moving forward.

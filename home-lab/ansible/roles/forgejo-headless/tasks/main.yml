- name: Install required system packages
  apt:
    name:
      - git
      - sqlite3
      - wget
      - gnupg2
    state: present
    update_cache: yes
  tags: [install]

- name: Create forgejo system group
  group:
    name: "{{ forgejo_group }}"
    system: yes
  tags: [install]

- name: Create forgejo system user
  user:
    name: "{{ forgejo_user }}"
    group: "{{ forgejo_group }}"
    shell: /bin/bash
    home: "/home/{{ forgejo_user }}"
    system: yes
    create_home: yes
  tags: [install]

- name: Create directory structure
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ forgejo_user }}"
    group: "{{ forgejo_group }}"
    mode: '0750'
  loop:
    - "{{ forgejo_home }}"
    - "{{ forgejo_home }}/custom"
    - "{{ forgejo_home }}/data"
    - "{{ forgejo_home }}/log"
    - "{{ forgejo_config_dir }}"
  tags: [install, config]

- name: Check current binary version
  command: "{{ forgejo_bin_path }} --version"
  register: current_version_check
  failed_when: false
  changed_when: false
  tags: [upgrade, install]

- name: Logic for binary upgrade
  block:
    - name: Backup current binary
      copy:
        src: "{{ forgejo_bin_path }}"
        dest: "{{ forgejo_bin_path }}.bak"
        remote_src: yes
      ignore_errors: yes

    - name: Remove old binary to force upgrade
      file:
        path: "{{ forgejo_bin_path }}"
        state: absent
  when: 
    - current_version_check.rc == 0
    - forgejo_version not in current_version_check.stdout
  tags: [upgrade]

- name: Download Forgejo binary
  get_url:
    url: "{{ forgejo_download_url }}"
    dest: "{{ forgejo_bin_path }}"
    mode: '0755'
    owner: root
    group: root
    force: yes
  register: binary_download
  tags: [install, upgrade]

- name: Deploy app.ini configuration
  template:
    src: app.ini.j2
    dest: "{{ forgejo_config_dir }}/app.ini"
    owner: "{{ forgejo_user }}"
    group: "{{ forgejo_group }}"
    mode: '0640'
  no_log: true
  register: config_deploy
  tags: [config]
  notify: restart forgejo

- name: Database Initialization and Migration
  become: yes
  become_user: "{{ forgejo_user }}"
  become_method: su
  environment:
    FORGEJO_WORK_DIR: "{{ forgejo_home }}"
    GITEA_WORK_DIR: "{{ forgejo_home }}"
  block:
    - name: Check if database tables exist
      command: sqlite3 {{ forgejo_home }}/data/forgejo.db "SELECT name FROM sqlite_master WHERE type='table' AND name='user';"
      register: db_check
      changed_when: false
      failed_when: false
    - name: Run migrations if new install or binary changed
      command: "{{ forgejo_bin_path }} admin db migrate --config {{ forgejo_config_dir }}/app.ini"
      when: db_check.stdout == "" or binary_download.changed  
  tags: [database, upgrade]


- name: Create initial admin user
  become: yes
  become_user: "{{ forgejo_user }}"
  become_method: su
  environment:
    FORGEJO_WORK_DIR: "{{ forgejo_home }}"
  command: >
    {{ forgejo_bin_path }} admin user create 
    --username "{{ forgejo_admin_user }}" 
    --password "{{ forgejo_admin_password }}" 
    --email "{{ forgejo_admin_email }}" 
    --admin 
    --config {{ forgejo_config_dir }}/app.ini
  register: admin_creation
  no_log: true
  when: db_check.stdout == ""
  failed_when: 
      - admin_creation.rc != 0 
      - "'user already exists' not in admin_creation.stderr"
  changed_when: "'successfully created' in admin_creation.stdout"
  tags: [database]

- name: Deploy systemd service unit
  template:
    src: forgejo.service.j2
    dest: /etc/systemd/system/forgejo.service
    owner: root
    group: root
    mode: '0644'
  tags: [install]
  notify: restart forgejo

- name: Ensure Forgejo is enabled and started
  systemd:
    name: forgejo
    enabled: yes
    state: started
    daemon_reload: yes
  tags: [install, maintenance]

# Store up to 4 weeks
- name: Configure log rotation
  template:
    src: forgejo.logrotate.j2
    dest: /etc/logrotate.d/forgejo
    owner: root
    group: root
    mode: '0644'
  tags: [maintenance]